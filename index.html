<!doctype html>
<html ng-app=. ng-controller=.>

<head>
	<title></title>
	<script src="bower_components/angular/angular.js"></script>
	<script src="bower_components/angular-q-state/$q.js"></script>
	<script>
		angular.module('.', [])
			.controller('.', function ($scope, $http) {
				$scope.connect = () => {
					$scope.$proxyRules = $http.get(`${$scope.endpoint}/proxy-rules`, { withCredentials: true });
					$scope.$app = $http.get(`${$scope.endpoint}/app/`, { withCredentials: true });
				};
				$scope.start = name => {
					var app = $scope.$app.value.data[name];
					app.starting = $http.post(`${$scope.endpoint}/app/${encodeURIComponent(name || 'default')}/start`, undefined, { withCredentials: true });
					app.starting.then(response => {
						app.running = true;
					});
				};
				$scope.stop = name => {
					var app = $scope.$app.value.data[name];
					app.stopping = $http.post(`${$scope.endpoint}/app/${encodeURIComponent(name || 'default')}/stop`, undefined, { withCredentials: true });
					app.stopping.then(response => {
						app.running = false;
					});
				};
			})
	</script>
</head>

<body>
	<form>target: <input type=text ng-model=endpoint><button ng-click=connect();>connect</button></form>
	<section ng-if=$proxyRules>
		<h4>proxy rules</h4>
		<div ng-if=$proxyRules.pending>loading..</div>
		<div ng-if=$proxyRules.rejected>error</div>
		<table ng-if=$proxyRules.resolved>
			<tr ng-repeat="(name,value) in $proxyRules.value.data">
				<td>{{name||"(default)"}}</td>
				<td>{{value}}</td>
			</tr>
		</table>
	</section>
	<section ng-if=$app>
		<h4>app</h4>
		<div ng-if=$app.pending>loading..</div>
		<div ng-if=$app.rejected>error</div>
		<table ng-if=$app.resolved>
			<tr ng-repeat="(name,value) in $app.value.data">
				<td>{{name||"(default)"}}</td>
				<td>{{value.module}}</td>
				<td>{{value.arguments}}</td>
				<td>
					{{value.running?"running":"not running"}}
					<span ng-if=value.stopping.pending>(stopping..)</span>
					<span ng-if=value.stopping.rejected>(stop failed)</span>
					<span ng-if=value.starting.pending>(starting..)</span>
					<span ng-if=value.starting.rejected>(start failed)</span>
					<button ng-if=value.running&&!value.stopping.pending ng-click=stop(name);>⏹</button>
					<button ng-if=!value.running&&!value.starting.pending ng-click=start(name);>⏵</button>
				</td>
			</tr>
		</table>
	</section>
</body>

</html>